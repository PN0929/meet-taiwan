<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trail Note - Local Friends Taiwan</title>
  <meta name="description" content="Local Friends Taiwan æ¢è·¯ç­†è¨˜å–®ç¯‡å…§å®¹ã€‚">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",sans-serif;
      line-height:1.6;color:#2D6A4F;background:#F7F5F2;
      text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;
      word-break:keep-all;overflow-wrap:anywhere;
    }
    img{max-width:100%;height:auto;display:block}
    h1,h2{text-wrap:balance}

    /* æµ®å‹•å°è¦½ */
    .floating-nav{
      position:fixed;left:20px;top:50%;transform:translateY(-50%);
      z-index:1000;background:#fff;padding:.75rem;border-radius:26px;
      box-shadow:0 4px 20px rgba(45,106,79,.18);border:2px solid #2D6A4F;
      opacity:0;animation:fadeInLeft 1s ease forwards .5s;
    }
    .floating-nav a{
      display:block;width:44px;height:44px;margin:.35rem 0;border-radius:50%;
      background:linear-gradient(135deg,#2D6A4F,#40916C);color:#fff;
      text-decoration:none;display:flex;align-items:center;justify-content:center;
      font-size:1.35rem;transition:.3s;
    }
    .floating-nav a:hover{
      transform:scale(1.15);
      background:linear-gradient(135deg,#40916C,#52B788);
      box-shadow:0 4px 14px rgba(64,145,108,.35);
    }

    /* å›é ‚ */
    .back-to-top{
      position:fixed;right:30px;bottom:30px;width:60px;height:60px;
      background:linear-gradient(135deg,#F4845F,#F4A261);color:#fff;border:none;
      border-radius:50%;font-size:1.5rem;cursor:pointer;
      box-shadow:0 4px 20px rgba(244,132,95,.4);display:none;z-index:999;
      transition:transform .3s;
    }
    .back-to-top:hover{transform:translateY(-5px)}
    .back-to-top.show{
      display:flex;align-items:center;justify-content:center;
      animation:fadeInUp .5s ease;
    }

    /* é ‚éƒ¨å°å“ç‰Œåˆ— */
    .top-bar{
      position:sticky;top:0;z-index:900;
      background:rgba(247,245,242,.98);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(45,106,79,.08);
    }
    .top-bar-inner{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:.6rem 1.5rem;font-size:.9rem;color:#2D6A4F;
    }
    .brand-small{
      font-weight:800;letter-spacing:.08em;font-size:.8rem;
    }
    .brand-small span{
      font-weight:500;margin-left:.35rem;font-size:.78rem;opacity:.8;
    }
    .top-nav-links{
      display:flex;gap:.8rem;font-size:.8rem;
    }
    .top-nav-links a{
      text-decoration:none;color:#2D6A4F;opacity:.8;
      padding:.25rem .55rem;border-radius:999px;
      border:1px solid transparent;transition:.2s;
    }
    .top-nav-links a:hover{
      opacity:1;border-color:#E9C46A;background:#FFF7EB;
    }
    .top-nav-links a.active{
      opacity:1;border-color:#2D6A4F;background:#fff;font-weight:700;
    }

    /* Hero å–®ç¯‡ */
    .hero{
      position:relative;
      padding:2.4rem 1.5rem 1.8rem;
      background:linear-gradient(180deg,#EAF4EE,#F7F5F2);
    }
    .hero-inner{
      max-width:1200px;margin:0 auto;
      display:grid;
      grid-template-columns:minmax(0,2fr) minmax(260px,1.3fr);
      gap:1.8rem;
      align-items:flex-start;
    }
    .note-label{
      font-size:.85rem;font-weight:700;color:#2D6A4F;
      letter-spacing:.16em;text-transform:uppercase;margin-bottom:.3rem;
    }
    #noteTitle{
      font-size:2rem;font-weight:800;color:#2D6A4F;margin-bottom:.3rem;
    }
    #noteSubtitle{
      font-size:1rem;color:#666;margin-bottom:.5rem;
    }
    .hero-meta{
      display:flex;flex-wrap:wrap;gap:.4rem;
      font-size:.78rem;color:#777;margin:.4rem 0 .8rem;
    }
    .badge{
      padding:.25rem .6rem;border-radius:999px;
      border:1px solid #E9C46A;background:#FFFBF3;
      font-size:.7rem;color:#8A6B2F;
    }
    #noteSummary{
      font-size:.9rem;color:#555;max-width:640px;line-height:1.7;
    }

    .hero-cover{
      border-radius:14px;overflow:hidden;
      box-shadow:0 6px 20px rgba(45,106,79,.16);
      background:#F7F5F2;
      min-height:180px;
    }
    .hero-cover img{
      width:100%;height:100%;object-fit:cover;
    }

    /* å…§æ–‡å€å¡Š */
    .content-wrap{
      max-width:1200px;margin:0 auto;
      padding:0 1.5rem 3rem;
    }
    .doc-card{
      margin-top:1.6rem;
      background:#fff;
      border-radius:16px;
      border:2px solid #E9C46A;
      box-shadow:0 4px 16px rgba(233,196,106,.16);
      padding:1.8rem 1.6rem;
    }
    .doc-card h2.title{
      font-size:1.3rem;
      font-weight:800;
      color:#2D6A4F;
      margin-bottom:.8rem;
      border-bottom:2px solid #E9C46A;
      padding-bottom:.4rem;
    }

    .doc-inner{
      max-width:840px;
      margin:0 auto;
      font-size:.96rem;
      color:#2f2f2f;
      line-height:1.9;
    }
    .doc-inner h1,
    .doc-inner h2,
    .doc-inner h3,
    .doc-inner h4{
      margin:1.4rem 0 .5rem;
      font-weight:800;
      color:#1f4d39;
      line-height:1.4;
    }
    .doc-inner p{
      margin:.6rem 0;
    }
    .doc-inner strong{font-weight:800}
    .doc-inner ul,
    .doc-inner ol{
      margin:.5rem 0 .5rem 1.2rem;
    }
    .doc-inner li{margin:.25rem 0}
    .doc-inner blockquote{
      margin:.8rem 0;
      padding:.7rem 1rem;
      border-left:4px solid #E9C46A;
      background:#FFF9E6;
      border-radius:8px;
      color:#444;
    }

    /* é—œéµï¼šåœ–ç‰‡å›ºå®šåœ¨å¡ç‰‡å¯¬åº¦å…§ï¼Œä¸å¤šé¤˜ç©ºç™½ã€ä¸çˆ†ç‰ˆ */
    .doc-inner img{
      max-width:100% !important;
      height:auto !important;
      display:block;
      margin:.75rem auto;
      border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .doc-inner figure{
      max-width:100%;
      margin:.75rem 0;
    }

    /* è¡¨æ ¼ç”¨æ©«å‘æ²å‹• */
    .doc-inner table{
      border-collapse:collapse;
      margin:.8rem 0;
      width:100%;
      display:block;
      overflow-x:auto;
    }
    .doc-inner th,
    .doc-inner td{
      border:1px solid #e3e3e3;
      padding:.4rem .55rem;
      font-size:.9rem;
      vertical-align:top;
      white-space:normal;
    }
    .doc-inner thead th{
      background:#f7f7f7;
      font-weight:700;
    }

    .doc-inner iframe{
      max-width:100% !important;
      width:100% !important;
      border:0;
      border-radius:8px;
      min-height:260px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      margin:.8rem 0;
    }

    .loading{
      text-align:center;
      padding:3rem 1.5rem;
      font-size:1rem;
      color:#2D6A4F;
      font-weight:700;
    }

    .footer{
      background:linear-gradient(135deg,#2D6A4F,#40916C);
      color:#fff;
      text-align:center;
      padding:2.5rem 2rem;
      font-size:.9rem;
    }
    .footer a{
      color:#fff;
      text-decoration:none;
      font-weight:bold;
    }
    .footer a:hover{text-decoration:underline}

    @keyframes fadeInLeft{
      from{opacity:0;transform:translate(-50px,-50%);}
      to{opacity:1;transform:translate(0,-50%);}
    }
    @keyframes fadeInUp{
      from{opacity:0;transform:translateY(20px);}
      to{opacity:1;transform:translateY(0);}
    }

    @media(max-width:768px){
      .floating-nav{
        left:10px;padding:.5rem;
      }
      .floating-nav a{
        width:38px;height:38px;font-size:1.1rem;margin:.25rem 0;
      }
      .top-bar-inner{
        padding:.5rem .9rem;
        flex-wrap:wrap;
        gap:.3rem .6rem;
      }
      .hero{
        padding:2rem 1.2rem 1.4rem;
      }
      .hero-inner{
        grid-template-columns:1fr;
      }
      #noteTitle{
        font-size:1.6rem;
      }
      .hero-cover{
        order:-1;
        max-height:220px;
      }
      .content-wrap{
        padding:0 1.2rem 2.4rem;
      }
      .doc-card{
        padding:1.4rem 1.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- æµ®å‹•å°è¦½ -->
  <nav class="floating-nav">
    <a href="index.html" title="é¦–é ">ğŸ </a>
    <a href="experiences.html" title="é«”é©—åˆ—è¡¨">ğŸŒŸ</a>
    <a href="notes.html" title="æ¢è·¯ç­†è¨˜">ğŸ“’</a>
    <a href="contact.html" title="è¯ç¹«æˆ‘å€‘">âœ‰ï¸</a>
  </nav>

  <button class="back-to-top" onclick="scrollToTop()">â†‘</button>

  <!-- é ‚éƒ¨å°å“ç‰Œåˆ— -->
  <header class="top-bar">
    <div class="top-bar-inner">
      <div class="brand-small">
        LOCAL FRIENDS TAIWAN
        <span>Trail Notes æ¢è·¯ç­†è¨˜</span>
      </div>
      <nav class="top-nav-links">
        <a href="index.html">Home</a>
        <a href="experiences.html">Experiences</a>
        <a href="about.html">About</a>
        <a href="faq.html">FAQ</a>
        <a href="hosts.html">Hosts</a>
        <a href="notes.html" class="active">Trail Notes</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <div id="loading" class="loading">è¼‰å…¥ç­†è¨˜ä¸­... Loading trail note...</div>

  <main id="mainContent" style="display:none;">
    <section class="hero">
      <div class="hero-inner">
        <div>
          <div class="note-label">TRAIL NOTE ãƒ» æ¢è·¯ç´€éŒ„</div>
          <h1 id="noteTitle"></h1>
          <div id="noteSubtitle"></div>
          <div class="hero-meta" id="noteMeta"></div>
          <div id="noteSummary"></div>
        </div>
        <div class="hero-cover" id="noteCover"></div>
      </div>
    </section>

    <section class="content-wrap">
      <div class="doc-card">
        <h2 class="title">ç­†è¨˜å…§å®¹ Trail Note Details</h2>
        <div class="doc-inner" id="docInner">
          <!-- Google Doc å…§å®¹è¼‰å…¥æ–¼æ­¤ -->
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p><strong>Local Friends Taiwan å°ç£åœ¨åœ°é€£ç·š</strong></p>
    <p style="margin-top:.4rem;">Your local friend in Taiwan | ä½ åœ¨å°ç£çš„åœ¨åœ°æœ‹å‹</p>
    <p style="margin-top:.4rem;">
      <a href="https://github.com/PN0929/meet-taiwan" target="_blank">ğŸ“‚ GitHub Project</a>
    </p>
    <p style="margin-top:.6rem;opacity:.9;">
      Â© 2025 Local Friends Taiwan. Independent information platform.
    </p>
  </footer>

  <script>
    // èˆ‡ notes.html å…±ç”¨åŒä¸€ä»½ Sheet
    const SHEET_ID = 'YOUR_NOTES_SHEET_ID';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

    document.addEventListener('DOMContentLoaded', loadNote);

    async function loadNote(){
      const params = new URLSearchParams(window.location.search);
      const id = (params.get('id') || '').trim();
      const loading = document.getElementById('loading');
      const main = document.getElementById('mainContent');

      if(!id){
        loading.textContent = 'æ‰¾ä¸åˆ°ç­†è¨˜ IDã€‚è«‹å¾æ¢è·¯ç­†è¨˜åˆ—è¡¨é€²å…¥ã€‚';
        return;
      }

      try{
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const rows = parseCSV(text);
        const headers = rows[0];
        const data = rows.slice(1);
        const note = data.map(r => {
          const o={};
          headers.forEach((h,i)=>o[h.trim()] = (r[i]||'').trim());
          return o;
        }).find(o => (o['ID'] || '').toLowerCase() === id.toLowerCase());

        if(!note){
          loading.textContent = 'æ‰¾ä¸åˆ°é€™ç¯‡æ¢è·¯ç­†è¨˜ã€‚è«‹è¿”å›åˆ—è¡¨ã€‚';
          return;
        }

        // å¡« Hero
        renderHero(note);
        // è¼‰å…¥ Doc
        await renderDoc(note);

        loading.style.display = 'none';
        main.style.display = 'block';
      }catch(e){
        console.error(e);
        loading.textContent = 'è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      }
    }

    function parseCSV(csv){
      const lines = csv.split('\n').filter(l=>l.trim().length>0);
      return lines.map(line=>{
        const values=[];let cur='';let inQ=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch === '"'){
            if(inQ && line[i+1] === '"'){cur+='"';i++;}
            else inQ=!inQ;
          }else if(ch === ',' && !inQ){
            values.push(cur);cur='';
          }else{
            cur+=ch;
          }
        }
        values.push(cur);
        return values;
      });
    }

    function renderHero(note){
      document.title = `${note['Title'] || 'Trail Note'} - Local Friends Taiwan`;

      const titleEl = document.getElementById('noteTitle');
      const subtitleEl = document.getElementById('noteSubtitle');
      const metaEl = document.getElementById('noteMeta');
      const summaryEl = document.getElementById('noteSummary');
      const coverEl = document.getElementById('noteCover');

      const title = note['Title'] || 'Untitled Trail Note';
      const subtitle = note['Subtitle'] || '';
      const cat = note['Category'] || '';
      const loc = note['Location'] || '';
      const host = note['Host'] || '';
      const date = note['Date'] || '';
      const summary = note['Summary'] || '';
      const cover = note['Cover'] || '';

      titleEl.textContent = title;
      subtitleEl.textContent = subtitle;

      let metaHtml = '';
      if(cat) metaHtml += `<span class="badge">${cat}</span>`;
      if(loc) metaHtml += `<span>ğŸ“ ${loc}</span>`;
      if(host) metaHtml += `<span>ğŸ‘¥ ${host}</span>`;
      if(date) metaHtml += `<span>ğŸ—“ï¸ ${date}</span>`;
      metaEl.innerHTML = metaHtml;

      summaryEl.textContent = summary;

      if(cover){
        coverEl.innerHTML = `<img src="${cover}" alt="${title}" loading="lazy"
          onerror="this.style.display='none';">`;
      }else{
        coverEl.style.display = 'none';
      }
    }

    async function renderDoc(note){
      const container = document.getElementById('docInner');
      container.innerHTML = 'è¼‰å…¥å…§å®¹ä¸­... Loading content...';

      const raw = (note['DocLink'] || '').trim();
      if(!raw){
        container.innerHTML = '<p>æ­¤ç­†è¨˜å°šæœªæä¾›è©³ç´°å…§å®¹ã€‚</p>';
        return;
      }
      const fetchURL = toFetchableDocURL(raw);

      try{
        const resp = await fetch(fetchURL, {mode:'cors'});
        const html = await resp.text();
        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        let main = tmp.querySelector('#contents') || tmp.querySelector('body') || tmp;
        main.querySelectorAll('script,style,header,nav,link').forEach(el => el.remove());

        const wrapper = document.createElement('div');
        wrapper.innerHTML = main.innerHTML;

        // æ¸…é™¤å°¾ç«¯å®Œå…¨ç©ºç™½æ®µè½ï¼Œé¿å…å¤šé¤˜å¤§ç©ºç™½
        wrapper.querySelectorAll('p').forEach(p=>{
          if(!p.textContent.trim() && !p.querySelector('img,table,iframe')){
            p.remove();
          }
        });

        // åœ–ç‰‡æ¨£å¼å·²åœ¨ CSS æ§åˆ¶ï¼Œé€™è£¡åªè£œä¸Š lazy èˆ‡éŒ¯èª¤è™•ç†
        wrapper.querySelectorAll('img').forEach(img=>{
          img.loading = 'lazy';
          img.removeAttribute('width');
          img.removeAttribute('height');
          img.onerror = () => {
            img.replaceWith(Object.assign(document.createElement('div'),{
              textContent:'ğŸ“· åœ–ç‰‡ç„¡æ³•è¼‰å…¥',
              style:'text-align:center;color:#888;padding:0.5rem 0;font-size:.85rem;'
            }));
          };
        });

        // è¡¨æ ¼åŒ…ä¸€å±¤ overflow å®¹å™¨ï¼ˆé›–ç„¶ CSS å·²è™•ç†ï¼Œé€™è£¡ä¿éšªï¼‰
        wrapper.querySelectorAll('table').forEach(t=>{
          const w = document.createElement('div');
          w.style.overflowX = 'auto';
          w.style.margin = '.6rem 0';
          t.parentNode.insertBefore(w,t);
          w.appendChild(t);
        });

        // Iframe å¯¬åº¦ä¿®æ­£
        wrapper.querySelectorAll('iframe').forEach(f=>{
          f.removeAttribute('width');
          f.style.width = '100%';
          f.style.maxWidth = '100%';
        });

        container.innerHTML = '';
        container.appendChild(wrapper);
      }catch(e){
        console.warn('Doc fetch blocked, fallback iframe', e);
        container.innerHTML = `
          <iframe src="${toEmbeddableIframeURL(raw)}"
            loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        `;
      }
    }

    function toFetchableDocURL(url){
      if(/\/document\/d\/e\/[^/]+\/pub/.test(url)){
        return url.includes('?') ? url : url + '?embedded=true';
      }
      const m = url.match(/\/document\/d\/([^/]+)/);
      if(m){
        const id = m[1];
        return `https://docs.google.com/document/d/${id}/export?format=html`;
      }
      return url;
    }
    function toEmbeddableIframeURL(url){
      if(/\/document\/d\/e\/[^/]+\/pub/.test(url)){
        return url.includes('?') ? url + '&embedded=true' : url + '?embedded=true';
      }
      const m = url.match(/\/document\/d\/([^/]+)/);
      if(m){
        const id = m[1];
        return `https://docs.google.com/document/d/${id}/preview?rm=minimal&embedded=true`;
      }
      return url;
    }

    // å›é ‚
    function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }
    window.addEventListener('scroll',()=>{
      const b=document.querySelector('.back-to-top');
      if(window.pageYOffset>300) b.classList.add('show');
      else b.classList.remove('show');
    });
  </script>
</body>
</html>
