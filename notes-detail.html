<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trail Note - Local Friends Taiwan</title>
  <meta name="description" content="Trail Notes detail from Local Friends Taiwan â€” field visits, host stories, and reflections from real on-the-ground exploration.">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --header-height: 56px;
      --max-width: 900px;
      --green: #2D6A4F;
      --bg: #F7F5F2;
      --accent: #F4845F;
      --accent-soft: #E9C46A;
    }

    html, body { overflow-x: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      line-height: 1.7;
      color: var(--green);
      background: var(--bg);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      word-break: keep-all;
      overflow-wrap: anywhere;
    }
    h1, h2, h3 { text-wrap: balance; }
    img, video { max-width: 100%; height: auto; display: block; }

    /* Header */
    .site-header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--header-height);
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
      background: rgba(247,245,242,0.98);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(45,106,79,0.06);
      z-index: 1100;
    }
    .brand {
      display: flex;
      flex-direction: column;
      justify-content: center;
      line-height: 1.2;
    }
    .brand a {
      text-decoration: none;
      color: var(--green);
    }
    .brand-en {
      font-weight: 700;
      letter-spacing: 0.11em;
      font-size: 0.78rem;
    }
    .brand-zh {
      opacity: 0.9;
      font-size: 0.78rem;
    }

    .main-nav {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .main-nav a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1.4px solid transparent;
      font-size: 0.86rem;
      font-weight: 700;
      color: var(--green);
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.18s;
    }
    .main-nav a span.en { margin-right: 0.18rem; }
    .main-nav a:hover,
    .main-nav a.active {
      border-color: var(--accent-soft);
      background: #FFF7EB;
      box-shadow: 0 2px 8px rgba(233,196,106,.25);
      transform: translateY(-1px);
    }

    .nav-toggle {
      display: none;
      margin-left: auto;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1.4px solid var(--green);
      background: transparent;
      color: var(--green);
      font-size: 1.2rem;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .nav-toggle:hover { background: #E9C46A22; }
    .nav-toggle.open {
      background: var(--green);
      color: #F7F5F2;
      border-color: var(--green);
    }

    @media (max-width: 768px) {
      .site-header {
        padding: 0 1rem;
      }
      .brand-en, .brand-zh {
        font-size: 0.74rem;
      }
      .main-nav {
        position: fixed;
        top: var(--header-height);
        left: 0; right: 0;
        padding: 0.45rem 0.85rem 0.55rem;
        background: rgba(247,245,242,0.98);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(45,106,79,0.08);
        display: none;
        flex-wrap: nowrap;
        gap: 0.45rem;
        overflow-x: auto;
        white-space: nowrap;
        z-index: 1090;
      }
      .main-nav.open { display: flex; }
      .main-nav::-webkit-scrollbar { height: 3px; }
      .main-nav::-webkit-scrollbar-thumb {
        background: rgba(233,196,106,0.9);
        border-radius: 999px;
      }
      .main-nav a {
        padding: 0.35rem 0.8rem;
        font-size: 0.8rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      }
      .nav-toggle { display: inline-flex; }
    }

    /* Back to top */
    .back-to-top {
      position: fixed;
      right: 30px;
      bottom: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg,#F4845F,#F4A261);
      color:#fff;
      border:none;
      border-radius:50%;
      font-size:1.5rem;
      cursor:pointer;
      box-shadow:0 4px 20px rgba(244,132,95,0.4);
      display:none;
      z-index:1000;
      transition:transform 0.3s;
    }
    .back-to-top:hover { transform:translateY(-5px); }
    .back-to-top.show {
      display:flex;
      align-items:center;
      justify-content:center;
      animation:fadeInUp 0.5s ease;
    }

    /* Hero / cover */
    .hero-cover {
      margin-top: var(--header-height);
      position: relative;
      width: 100%;
      height: 220px;
      background: linear-gradient(135deg,#2D6A4F,#40916C);
      overflow: hidden;
    }
    .hero-cover-img {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      filter:brightness(0.7);
    }
    .hero-cover-overlay {
      position:absolute;
      inset:0;
      background:linear-gradient(to bottom,
        rgba(0,0,0,0.45),
        rgba(0,0,0,0.5),
        rgba(0,0,0,0.75)
      );
    }

    .hero-meta {
      position: relative;
      max-width: var(--max-width);
      margin: -80px auto 0;
      padding: 1.2rem 1.4rem 1.3rem;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.14);
      border: 1px solid #E5DECF;
    }
    .note-type-label {
      font-size: 0.72rem;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      background: #FFF7EB;
      border: 1px solid #E9C46A;
      color: #8a6230;
      display:inline-flex;
      align-items:center;
      gap:0.22rem;
      margin-bottom:0.3rem;
    }
    .note-title-en {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--green);
      margin-bottom: 0.15rem;
    }
    .note-title-zh {
      font-size: 0.92rem;
      color: #777;
      margin-bottom: 0.45rem;
    }
    .note-meta-line {
      display:flex;
      flex-wrap:wrap;
      gap:0.8rem;
      font-size:0.78rem;
      color:#888;
      margin-bottom:0.2rem;
    }
    .note-tags-line {
      display:flex;
      flex-wrap:wrap;
      gap:0.25rem;
      margin-top:0.15rem;
    }
    .note-tag-pill {
      padding:0.14rem 0.55rem;
      border-radius:999px;
      background:#F7F5F2;
      border:1px solid #E9C46A;
      font-size:0.7rem;
      color:#566;
    }

    /* Content */
    .content-wrap {
      max-width: var(--max-width);
      margin: 1.2rem auto 3rem;
      padding: 0 1.5rem 0.5rem;
    }
    .content-inner {
      background:#fff;
      padding:1.6rem 1.5rem 1.8rem;
      border-radius:16px;
      border:1px solid #E5DECF;
      box-shadow:0 4px 16px rgba(0,0,0,0.03);
      font-size:0.98rem;
      color:#333;
    }

    .content-inner h1,
    .content-inner h2,
    .content-inner h3,
    .content-inner h4 {
      margin:1.2rem 0 0.6rem;
      color:#1f4d39;
      font-weight:700;
      line-height:1.35;
    }
    .content-inner p {
      margin:0.6rem 0;
      line-height:1.8;
      color:#333;
      font-size:0.98rem;
    }
    .content-inner strong { font-weight:700; }
    .content-inner ul,
    .content-inner ol {
      margin:0.6rem 0 0.6rem 1.25rem;
      padding-left:0.2rem;
    }
    .content-inner li {
      margin:0.25rem 0;
      line-height:1.7;
    }
    .content-inner blockquote {
      border-left:4px solid var(--accent-soft);
      background:#FFF9EE;
      padding:0.7rem 1rem;
      border-radius:8px;
      margin:0.8rem 0;
      font-size:0.94rem;
      color:#555;
    }
    .content-inner img {
      max-width:100% !important;
      height:auto !important;
      display:block;
      margin:1rem auto;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
    }
    .content-inner table {
      width:100%;
      border-collapse:collapse;
      margin:1rem 0;
      display:block;
      overflow-x:auto;
    }
    .content-inner th,
    .content-inner td {
      border:1px solid #e6e6e6;
      padding:0.5rem 0.6rem;
      font-size:0.9rem;
      text-align:left;
      vertical-align:top;
    }
    .content-inner thead th {
      background:#f7f7f7;
      font-weight:700;
    }
    .content-inner iframe {
      max-width:100%;
      width:100% !important;
      border:0;
      border-radius:10px;
      min-height:260px;
      box-shadow:0 2px 10px rgba(0,0,0,0.04);
      margin:0.8rem 0;
    }

    .loading {
      text-align:center;
      padding:3rem 1rem;
      font-size:0.98rem;
      color:#666;
    }

    .footer {
      background: linear-gradient(135deg,#2D6A4F,#40916C);
      color:#fff;
      text-align:center;
      padding:2.4rem 2rem;
      margin-top:2rem;
    }

    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(18px); }
      to   { opacity:1; transform:translateY(0); }
    }

    @media (max-width: 768px) {
      .hero-cover { height: 180px; }
      .hero-meta {
        margin: -70px auto 0;
        padding: 1rem 1.1rem 1.2rem;
        border-radius: 14px;
      }
      .note-title-en {
        font-size: 1.3rem;
      }
      .note-title-zh {
        font-size: 0.86rem;
      }
      .content-wrap {
        padding: 0 1.1rem 0.5rem;
      }
      .content-inner {
        padding: 1.1rem 1rem 1.4rem;
        font-size: 0.94rem;
      }
      .back-to-top {
        right: 16px;
        bottom: 16px;
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="brand">
      <a href="index.html">
        <div class="brand-en">LOCAL FRIENDS TAIWAN</div>
        <div class="brand-zh">å°ç£åœ¨åœ°é€£ç·š</div>
      </a>
    </div>
    <nav class="main-nav" id="mainNav">
      <a href="experiences.html"><span class="en">Experiences</span><span class="zh">é«”é©—åˆ—è¡¨</span></a>
      <a href="about.html"><span class="en">About</span><span class="zh">é—œæ–¼æˆ‘å€‘</span></a>
      <a href="faq.html"><span class="en">FAQ</span><span class="zh">å¸¸è¦‹å•é¡Œ</span></a>
      <a href="hosts.html"><span class="en">For Hosts</span><span class="zh">æˆç‚ºåœ¨åœ°æœ‹å‹</span></a>
      <a href="notes.html" class="active"><span class="en">Trail Notes</span><span class="zh">æ¢è·¯ç­†è¨˜</span></a>
      <a href="contact.html"><span class="en">Contact</span><span class="zh">è¯ç¹«æˆ‘å€‘</span></a>
    </nav>
    <button class="nav-toggle" id="navToggle" aria-label="åˆ‡æ›å°è¦½é¸å–®">â˜°</button>
  </header>

  <!-- Back to top -->
  <button class="back-to-top" onclick="scrollToTop()">â†‘</button>

  <!-- Hero cover -->
  <section class="hero-cover">
    <img id="coverImg" class="hero-cover-img" src="" alt="" style="display:none;">
    <div class="hero-cover-overlay"></div>
  </section>

  <!-- Meta card -->
  <section class="hero-meta" id="heroMeta">
    <div class="note-type-label" id="typeLabel" style="display:none;"></div>
    <div class="note-title-en" id="titleEn">Loading Trail Note...</div>
    <div class="note-title-zh" id="titleZh"></div>
    <div class="note-meta-line" id="metaLine"></div>
    <div class="note-tags-line" id="tagsLine"></div>
  </section>

  <!-- Content -->
  <main class="content-wrap">
    <div id="contentInner" class="content-inner">
      <div class="loading">Loading note content... Trail Notes å…§å®¹è¼‰å…¥ä¸­...</div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p style="font-size:1.2rem;margin-bottom:0.6rem;"><strong>Local Friends Taiwan å°ç£åœ¨åœ°é€£ç·š</strong></p>
    <p>Your local friend in Taiwan | ç•¶ä½ éœ€è¦ä¸€ä½å°ç£åœ¨åœ°çš„æœ‹å‹</p>
    <p style="margin-top:1.2rem;opacity:0.9;font-size:0.95rem;">
      Â© 2025 Local Friends Taiwan. Independent Information Platform.
    </p>
  </footer>

  <script>
    const SHEET_ID  = '1icnZhegrhiUdaWz_BgQK0CQ_oueDhPhZgnl3opy9PJs';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

    document.addEventListener('DOMContentLoaded', () => {
      // Nav toggle
      const navToggle = document.getElementById('navToggle');
      const mainNav = document.getElementById('mainNav');
      if (navToggle && mainNav) {
        navToggle.addEventListener('click', () => {
          const isOpen = mainNav.classList.toggle('open');
          navToggle.classList.toggle('open', isOpen);
        });
        mainNav.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            if (mainNav.classList.contains('open')) {
              mainNav.classList.remove('open');
              navToggle.classList.remove('open');
            }
          });
        });
      }

      loadNoteDetail();
    });

    async function loadNoteDetail(){
      const params = new URLSearchParams(window.location.search);
      const id = (params.get('id') || '').trim();
      const contentInner = document.getElementById('contentInner');

      if (!id){
        document.getElementById('titleEn').textContent = 'Note not found';
        document.getElementById('titleZh').textContent = 'æ‰¾ä¸åˆ°å°æ‡‰çš„ç­†è¨˜ IDã€‚';
        contentInner.innerHTML = `
          <div class="loading">
            Unable to find this Trail Note.<br>
            è«‹å¾ Trail Notes æ¢è·¯ç­†è¨˜é é¢é‡æ–°é»é¸ã€‚
          </div>`;
        return;
      }

      try{
        const resp = await fetch(SHEET_URL);
        const txt = await resp.text();
        const rows = parseCSV(txt);
        const headers = rows[0];
        const data = rows.slice(1);

        const list = data.map(r=>{
          const o={};
          headers.forEach((h,i)=>{ o[h.trim()] = (r[i]||'').trim(); });
          return o;
        });

        const note = list.find(o=>{
          const nid = (o['ID'] || o['Id'] || '').trim();
          return nid && nid.toLowerCase() === id.toLowerCase();
        });

        if (!note){
          document.getElementById('titleEn').textContent = 'Note not found';
          document.getElementById('titleZh').textContent = 'æ‰¾ä¸åˆ°é€™ç¯‡æ¢è·¯ç­†è¨˜';
          contentInner.innerHTML = `
            <div class="loading">
              We couldnâ€™t locate this Trail Note in the sheet.<br>
              è«‹è¿”å› Trail Notes æ¢è·¯ç­†è¨˜é‡æ–°é¸æ“‡ã€‚
            </div>`;
          return;
        }

        renderMeta(note);
        await renderDoc(note);
      }catch(err){
        console.error(err);
        contentInner.innerHTML = `
          <div class="loading">
            âš ï¸ Unable to load this Trail Note.<br>
            ç„¡æ³•è¼‰å…¥å…§å®¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚
          </div>`;
      }
    }

    function parseCSV(csv){
      const lines = csv.split('\n').filter(l => l.trim().length > 0);
      return lines.map(line => {
        const values = [];
        let cur = '';
        let inQ = false;
        for (let i=0;i<line.length;i++){
          const ch = line[i];
          if (ch === '"') {
            if (inQ && line[i+1] === '"') { cur += '"'; i++; }
            else { inQ = !inQ; }
          } else if (ch === ',' && !inQ) {
            values.push(cur);
            cur = '';
          } else {
            cur += ch;
          }
        }
        values.push(cur);
        return values;
      });
    }

    function mapTypeLabel(type){
      const map = {
        'Field Report': 'Field Report Â· æ¢è¨ªç´€éŒ„',
        'Behind the Hosts': 'Behind the Hosts Â· å¹•å¾Œæ•…äº‹',
        'Travel Mindset': 'Travel Mindset Â· æ—…äººå¿ƒæ…‹',
        'Updates': 'Updates Â· æœ€æ–°æ¶ˆæ¯'
      };
      return map[type] || type || '';
    }

    function renderMeta(n){
      const titleEn = n['Title_en'] || '';
      const titleZh = n['Title_zh'] || '';
      const type = n['Type'] || '';
      const date = n['Date'] || '';
      const author = n['Author'] || '';
      const tags = (n['Tags'] || '').split(/[,\sã€]+/).filter(Boolean);
      const cover = n['CoverImage'] || n['Cover'] || '';

      if (titleEn) {
        document.title = `${titleEn} - Trail Notes | Local Friends Taiwan`;
      }

      document.getElementById('titleEn').textContent = titleEn || 'Trail Note';
      document.getElementById('titleZh').textContent = titleZh ? titleZh : '';

      const typeLabel = document.getElementById('typeLabel');
      if (type) {
        typeLabel.style.display = 'inline-flex';
        typeLabel.textContent = mapTypeLabel(type);
      }

      const metaLine = document.getElementById('metaLine');
      const metaParts = [];
      if (date) metaParts.push(`ğŸ“… ${date}`);
      if (author) metaParts.push(`âœï¸ ${author}`);
      if (type) metaParts.push(`ğŸ“‚ ${type}`);
      metaLine.textContent = metaParts.join(' Â· ');

      const tagsLine = document.getElementById('tagsLine');
      if (tags.length) {
        tags.forEach(t => {
          const span = document.createElement('span');
          span.className = 'note-tag-pill';
          span.textContent = t;
          tagsLine.appendChild(span);
        });
      }

      const cov = document.getElementById('coverImg');
      if (cover) {
        cov.src = cover;
        cov.style.display = 'block';
        cov.onerror = () => { cov.style.display = 'none'; };
      }
    }

    async function renderDoc(n){
      const contentInner = document.getElementById('contentInner');
      const urlRaw = (n['DocURL'] || n['DocUrl'] || n['doc'] || '').trim();

      if (!urlRaw){
        contentInner.innerHTML = `
          <p>ç›®å‰å°šæœªæä¾›å®Œæ•´å…§æ–‡ã€‚</p>
          <p style="color:#777;font-size:0.9rem;">
            The host or editor hasnâ€™t added detailed notes yet. å…§å®¹æ›´æ–°å¾Œï¼Œæˆ‘å€‘æœƒåœ¨é€™è£¡åŒæ­¥ã€‚</p>`;
        return;
      }

      const fetchURL = toFetchableDocURL(urlRaw);

      try{
        const resp = await fetch(fetchURL, { mode: 'cors' });
        const html = await resp.text();

        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        let main = tmp.querySelector('#contents') || tmp.querySelector('body') || tmp;

        // ç§»é™¤é›œè¨Š
        main.querySelectorAll('script,style,header,nav,footer,link,meta').forEach(el=>el.remove());

        const wrapper = document.createElement('div');
        wrapper.innerHTML = main.innerHTML;

        // æ¸…ç†åœ–ç‰‡
        wrapper.querySelectorAll('img').forEach(img => {
          img.removeAttribute('width');
          img.removeAttribute('height');
          img.loading = 'lazy';
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          img.style.display = 'block';
          img.style.margin = '1rem auto';
          img.style.borderRadius = '10px';
          img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.06)';
        });

        // è¡¨æ ¼æ©«å‘å·è»¸
        wrapper.querySelectorAll('table').forEach(t => {
          const w = document.createElement('div');
          w.style.overflowX = 'auto';
          w.style.margin = '1rem 0';
          t.parentNode.insertBefore(w, t);
          w.appendChild(t);
        });

        // iframe å¯¬åº¦èª¿æ•´
        wrapper.querySelectorAll('iframe').forEach(f => {
          f.removeAttribute('width');
          f.style.width = '100%';
          f.style.maxWidth = '100%';
        });

        contentInner.innerHTML = '';
        contentInner.appendChild(wrapper);
      }catch(err){
        console.error('Doc fetch failed, fallback iframe', err);
        contentInner.innerHTML = `
          <iframe src="${toEmbeddableIframeURL(urlRaw)}"
                  loading="lazy"
                  style="width:100%;height:800px;border:0;border-radius:12px;background:#fff;"></iframe>
          <p style="margin-top:0.6rem;font-size:0.85rem;color:#777;">
            è‹¥ç„¡æ³•æ­£å¸¸é¡¯ç¤ºï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–é‡æ–°æ•´ç†é é¢ã€‚
          </p>`;
      }
    }

    function toFetchableDocURL(url){
      if (/\/document\/d\/e\/[^/]+\/pub/.test(url)) {
        return url.includes('?') ? url : url + '?embedded=true';
      }
      const m = url.match(/\/document\/d\/([^/]+)/);
      if (m) {
        const id = m[1];
        return `https://docs.google.com/document/d/${id}/export?format=html`;
      }
      return url;
    }

    function toEmbeddableIframeURL(url){
      if (/\/document\/d\/e\/[^/]+\/pub/.test(url)) {
        return url.includes('?') ? url + '&embedded=true' : url + '?embedded=true';
      }
      const m = url.match(/\/document\/d\/([^/]+)/);
      if (m) {
        const id = m[1];
        return `https://docs.google.com/document/d/${id}/preview?rm=minimal&embedded=true`;
      }
      return url;
    }

    // Back to top
    window.addEventListener('scroll', () => {
      const b = document.querySelector('.back-to-top');
      if (!b) return;
      if (window.pageYOffset > 300) b.classList.add('show');
      else b.classList.remove('show');
    });
    function scrollToTop(){
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
